<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Library</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet"/>
    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
</head>
<body>
<form name="findBooks">
    <input type="hidden" name="id" value="0"/>
    <div class="form-group">
        <label for="name">Название книги:</label>
        <input class="form-control" name="bookName"/>
    </div>
    <div class="form-group">
        <label for="author">Автор:</label>
        <input class="form-control" name="author"/>
    </div>
    <div class="panel-body">
        <a id="Create" class="btn btn-sm btn-primary">Добавить книгу</a>
        <a id="Find" class="btn btn-sm btn-primary">Найти книги</a>
    </div>
</form>

<h2>books</h2>
<a id="All" class="btn btn-sm btn-primary">Show Library</a>
<div id="baza"></div>

<script>
    $("#All").click(function (e) {
        $.ajax({
            url: "/api/books",
            type: "GET",
            contentType: "application/json",
            success: function (books) {
                $("#baza").html(booksToHtml(books));
            }
        });
    });

    $("#Create").click(function (e) {
        //  e.preventDefault();
        var form = document.forms["findBooks"];
        var name = form.elements["bookName"].value;
        var author = form.elements["author"].value;
        $.ajax({
            url: "api/addBook",
            contentType: "application/json",
            method: "POST",
            data: JSON.stringify({
                name: name,
                author: author
            })
        });
        $('#All').triggerHandler('click');
    });

    $("#Find").click(function (e) {
        //  e.preventDefault();
        var form = document.forms["findBooks"];
        var name = form.elements["bookName"].value;
        var author = form.elements["author"].value;
        console.log(name + ' ' + author);

        $.ajax({
            url: "api/findBooks",
            contentType: "application/json",
            method: "POST",
            data: JSON.stringify({
                name: name,
                author: author
            }),
            success: function (books) {
                $("#baza").html(booksToHtml(books));
            }
        });
    });

    var bookToHtml = function (book) {
        if (!book.issued) return '<div>' + ' ' + book.author + ' "' + book.name + '"         ' +
            '<a class="issueLink" id="' + book._id + '">Выдать  </a>' +
            '<a class="deleteLink" id="' + book._id + '">  Удалить </a>' +
            '</div>';
        return '<div>' + ' ' + book.author + ' "' + book.name + '" Выдана абоненту ' + book.issuedto + ' в ' + book.issued +
            ' <a class="returnLink" id=' + book._id + '> Вернуть  </a>' +
            '<a class="deleteLink" id="' + book._id + '">  Удалить </a>' +
            '</div>';

    };

    var booksToHtml = function (books) {
        var rows = "";
        for (var i = 0; i < books.length; i++) {
            rows = rows + bookToHtml(books[i]);
        }
        return rows;
    }

    function issueBook(id, abonent) {
        $.ajax({
            url: "api/issueBook",
            contentType: "application/json",
            method: "POST",
            data: JSON.stringify({
                id: id,
                abonent: abonent
            })
        })
    }

    function returnBook(id) {
        $.ajax({
            url: "api/returnBook",
            contentType: "application/json",
            method: "POST",
            data: JSON.stringify({
                id: id
            })
        });
        $('#All').triggerHandler('click');
    }

    function deleteBook(id) {
        $.ajax({
            url: "api/deleteBook",
            contentType: "application/json",
            method: "POST",
            data: JSON.stringify({
                id: id
            })
        });
        $('#All').triggerHandler('click');
    }



    $("body").on("click", ".issueLink", function () {
        var id = this.id;
        var abonent = prompt('Введите имя абонента, которому будет выдана книга', '');
        if (abonent) issueBook(id, abonent);
        $('#All').triggerHandler('click');
    });

    $("body").on("click", ".returnLink", function () {
        var id = this.id;
        returnBook(id);
    });

    $("body").on("click", ".deleteLink", function () {
        var id = this.id;
        deleteBook(id);
    });


    $('#All').triggerHandler('click');
</script>
</body>
</html>